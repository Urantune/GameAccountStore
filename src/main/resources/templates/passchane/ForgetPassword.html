<!doctype html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>QuÃªn máº­t kháº©u</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <!-- CSRF -->
    <meta th:if="${_csrf != null}" name="_csrf" th:content="${_csrf.token}"/>
    <meta th:if="${_csrf != null}" name="_csrf_header" th:content="${_csrf.headerName}"/>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>

    <style>
        body{
            background:#f0f0f0;
            min-height:100vh;
            display:flex;
            align-items:center;
            justify-content:center;
        }
        .card{
            width:600px;
            background:#f0e4e4;
            color:#000;
            border-radius:16px;
        }
        .form-control{
            padding:12px 14px;
            font-size:16px;
            background:#f0f0f0;
            border:1px solid #333;
        }
        .btn{ padding:12px; font-size:16px; }
    </style>
</head>
<body>

<div class="card shadow p-5">
    <h4 class="text-center mb-2">ğŸ”‘ QuÃªn máº­t kháº©u</h4>
    <p class="text-center text-muted mb-4">Nháº­p email Ä‘Ã£ Ä‘Äƒng kÃ½, há»‡ thá»‘ng sáº½ gá»­i link Ä‘á»•i máº­t kháº©u.</p>

    <div id="msgBox" class="alert d-none mb-3"></div>

    <form id="forgotPageForm">
        <div class="mb-3">
            <label class="form-label">Email Ä‘Ã£ Ä‘Äƒng kÃ½</label>
            <input type="email" name="email" id="email" class="form-control" placeholder="example@gmail.com" required>
        </div>

        <button type="submit" class="btn btn-primary w-100">
            Gá»­i email Ä‘á»•i máº­t kháº©u
        </button>
    </form>

    <div class="text-center mt-4">
        <a href="/home" class="text-decoration-none">â† Vá» trang chá»§</a>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    function getCsrf() {
        const tokenEl = document.querySelector('meta[name="_csrf"]');
        const headerEl = document.querySelector('meta[name="_csrf_header"]');
        return {
            token: tokenEl ? tokenEl.getAttribute('content') : null,
            header: headerEl ? headerEl.getAttribute('content') : null
        };
    }

    function showMsg(type, text) {
        const box = document.getElementById("msgBox");
        box.classList.remove("d-none", "alert-success", "alert-danger", "alert-warning");
        box.classList.add(type === "success" ? "alert-success" : "alert-danger");
        box.textContent = text;
        setTimeout(() => box.classList.add("d-none"), 4000);
    }

    document.getElementById("forgotPageForm").addEventListener("submit", function(e){
        e.preventDefault();

        const email = document.getElementById("email").value.trim();
        if (!email) return;

        const { token, header } = getCsrf();
        const headers = {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-Requested-With": "XMLHttpRequest"
        };
        if (token && header) headers[header] = token;

        fetch("/home/forgot-password", {
            method: "POST",
            headers,
            body: "email=" + encodeURIComponent(email)
        })
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    showMsg("error", data.error);
                } else if (data.success) {
                    showMsg("success", data.success);
                    document.getElementById("forgotPageForm").reset();
                } else {
                    showMsg("error", "CÃ³ lá»—i xáº£y ra. Vui lÃ²ng thá»­ láº¡i.");
                }
            })
            .catch(() => showMsg("error", "KhÃ´ng thá»ƒ káº¿t ná»‘i server. Vui lÃ²ng thá»­ láº¡i."));
    });
</script>

</body>
</html>
