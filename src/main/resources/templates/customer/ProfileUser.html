<!doctype html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>Profile User</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <!-- CSRF -->
    <meta th:if="${_csrf != null}" name="_csrf" th:content="${_csrf.token}"/>
    <meta th:if="${_csrf != null}" name="_csrf_header" th:content="${_csrf.headerName}"/>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" th:href="@{/css/ProfileUser.css}">
    <style>
        .toast-message {
            position: fixed;
            right: 16px;
            bottom: 16px;
            opacity: 0;
            transition: opacity .2s;
            z-index: 2000;
            padding: 8px 12px;
            border-radius: 6px
        }

        .toast-message.show {
            opacity: 1
        }
    </style>
</head>
<body>
<div class="container">
    <div class="card bg-dark text-light p-3 rounded-3 shadow" style="flex:1;">
        <div class="avatar text-center">
            <img src="/img/aov.jpg"
                 alt="Avatar" id="currentAvatar" class="rounded-circle"
                 style="width:120px;height:120px;object-fit:cover;border:2px solid #666;cursor:pointer;">
        </div>

        <input type="hidden" id="userIdHidden" th:value="${customer.getCustomerId()}"/>

        <div class="d-flex align-items-center justify-content-center mt-2">
            <h2 id="displayName" class="m-0" style="font-size:1.5rem;" th:text="${customer.username}">User Name</h2>
        </div>
        <!-- Modal ch·ªçn avatar -->
        <div class="modal fade" id="avatarModal" tabindex="-1" aria-labelledby="avatarModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content bg-dark text-light">
                    <div class="modal-header">
                        <h5 class="modal-title" id="avatarModalLabel">Ch·ªçn ·∫£nh ƒë·∫°i di·ªán</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-center">
                        <form id="avatarForm">
                            <div class="d-flex flex-wrap justify-content-center gap-2" id="avatarOptions"></div>
                            <button type="submit" class="btn btn-success mt-3">L∆∞u ·∫£nh</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="info mt-3">
            <p>Email: <span id="emailMasked" th:text="${customer.email}"></span></p>
            <a th:href="@{/logout}" class="btn btn-outline-danger mt-2">ƒêƒÉng xu·∫•t</a>
        </div>
    </div>

    <div class="card" style="flex:2;">
        <h2>üéÆ Th∆∞ vi·ªán game</h2>
        <div class="games" id="gameLibrary">
            <div class="game-card"
                 th:each="a : ${listGame}">

                <p th:text="${a.game.gameName}">CS:GO</p>
            </div>
        </div>

        <h2 style="margin-top:20px;">üèÜ Th√†nh t√≠ch</h2>
        <div class="achievements">
            <ul id="achievementList">
                <li>üî• Ho√†n th√†nh 100 gi·ªù ch∆°i GTA V</li>
                <li>üéØ Rank Immortal trong Dota 2</li>
                <li>‚ö° MVP 50 tr·∫≠n trong CS:GO</li>
            </ul>
        </div>
    </div>

    <div style="flex:1;">
        <div id="walletCard" class="card wallet text-center p-4 shadow-lg"
             style="cursor:pointer;transition:transform .3s;">
            <h2 class="mb-2" style="color:#222;">üí∞ V√≠ GamePay</h2>
            <p class="text-muted mb-0" id="walletStatus">Ch∆∞a k√≠ch ho·∫°t</p>
        </div>

        <div class="card transactions mt-3">
            <h2>üßæ Th√¥ng tin</h2>
            <a th:href="@{/welcome/transactions}"><h5 class="mt-2 text-white">1. L·ªãch s·ª≠ giao d·ªãch</h5></a>
            <a th:href="@{/welcome/transactions}"><h5 class="mt-3 text-white">2. Game ƒë√£ mua</h5></a>
            <a th:href="@{/welcome/transactions}"><h5 class="mt-3 text-white">3. Y√™u c·∫ßu ho√†n ti·ªÅn</h5></a>
            <a th:href="@{/welcome/transactions}"><h5 class="mt-3 text-white">4. Giao d·ªãch ƒëang x·ª≠ l√Ω</h5></a>
            <a th:href="@{/welcome/transactions}"><h5 class="mt-3 text-white">5. Th√¥ng b√°o</h5></a>
        </div>

        <div class="card settings">
            <h2>‚öôÔ∏è C√†i ƒë·∫∑t</h2>
            <!--            <a th:href="@{/welcome/editprofile/{id}(id=${user.id})}">-->
            <!--                <button id="btnChangePassword">ƒê·ªïi m·∫≠t kh·∫©u</button>-->
            <!--            </a>-->
            <button id="btnToggle2FA">B·∫≠t/T·∫Øt 2FA</button>
            <button id="btnDeleteAccount" class="btn btn-danger mt-2">X√≥a t√†i kho·∫£n</button>
        </div>
    </div>
</div>


<!-- MODAL X√ìA USER -->
<div class="modal fade" id="deleteUserModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title">X√≥a t√†i kho·∫£n</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a t√†i kho·∫£n n√†y kh√¥ng?</p>
                <p class="text-warning mb-0">H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteUserBtn">X√≥a</button>
            </div>
        </div>
    </div>
</div>

<div id="pinPopup" class="modal"
     style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);justify-content:center;align-items:center;">
    <div style="background:radial-gradient(circle at top,#19002b 0%,#0a0a0a 100%);padding:30px;border-radius:10px;width:350px;text-align:center;">
        <h5 style="color:#ffcd39;">V√≠ GamePay</h5>
        <p class="text-white">Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u c·ªßa v√≠</p>
        <input type="password" id="walletPin" maxlength="4" class="form-control mb-3 text-center"
               style="letter-spacing:5px;font-size:20px;">
        <div id="pinError" class="text-danger mb-2"></div>
        <button class="btn btn-primary px-4" id="verifyPinBtn">X√°c nh·∫≠n</button>
        <button class="btn btn-secondary px-3" id="closePinBtn">H·ªßy</button>
    </div>
</div>

<div id="toast" class="toast-message"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const DEFAULT_AVATARS = [
        '/img/b.jpg',
        '/img/Khng_c_tiu_.jpg',
        '/img/JoLong.jpg',
        '/img/img1.jpg',
        '/img/BiTrong.jpg',
        '/img/5000.jpg'
    ];

    const STORAGE_KEYS = {
        name: 'gs_profile_name',
        email: 'gs_profile_email',
        phone: 'gs_profile_phone',
        country: 'gs_profile_country',
        walletPin: 'gs_wallet_pin',
        walletActive: 'gs_wallet_active'
    };

    const $ = (sel) => document.querySelector(sel);

    function getCsrf() {
        const token = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
        const header = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');
        return {token, header};
    }

    function maskEmail(email) {
        if (!email || !email.includes('@')) return email || '';
        const [name, domain] = email.split('@');
        if (name.length <= 2) return '*@' + domain;
        return name.slice(0, 2) + '*'.repeat(Math.max(1, name.length - 2)) + '@' + domain;
    }

    function showToast(msg, isError) {
        const t = $('#toast');
        t.textContent = msg;
        t.style.background = isError ? '#e74c3c' : '#2ecc71';
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 3000);
    }

    function renderAvatarOptions(currentSrc) {
        const wrap = document.getElementById('avatarOptions');
        wrap.innerHTML = '';
        DEFAULT_AVATARS.forEach(src => {
            const label = document.createElement('label');
            label.style.cursor = 'pointer';
            label.innerHTML = `
        <input type="radio" name="avatar" value="${src}" style="display:none;" ${src === currentSrc ? 'checked' : ''}>
        <img src="${src}" class="rounded-circle border border-2"
             style="width:80px;height:80px;cursor:pointer;border-color:${src === currentSrc ? 'lime' : 'transparent'};">
      `;
            label.querySelector('img').addEventListener('click', (e) => {
                wrap.querySelectorAll('img').forEach(i => i.style.borderColor = 'transparent');
                e.target.style.borderColor = 'lime';
                label.querySelector('input').checked = true;
                document.getElementById('currentAvatar').src = src;
            });
            wrap.appendChild(label);
        });
    }

    function initProfile() {
        const name = localStorage.getItem(STORAGE_KEYS.name) || $('#displayName')?.innerText || '';
        const email = localStorage.getItem(STORAGE_KEYS.email) || $('#emailMasked')?.innerText || '';
        const phone = localStorage.getItem(STORAGE_KEYS.phone) || '';
        const country = localStorage.getItem(STORAGE_KEYS.country) || '';
        if (name) $('#displayName').innerText = name;
        if (email) $('#emailMasked').innerText = maskEmail(email);
        if (document.getElementById('phoneDisplay')) {
            document.getElementById('phoneDisplay').innerText = phone || '----------';
        }
        document.getElementById('countryDisplay').innerText = country || '----------';
    }

    document.getElementById('currentAvatar').addEventListener('click', () => {
        const modalEl = document.getElementById('avatarModal');
        const avatarModal = new bootstrap.Modal(modalEl);
        const current = document.getElementById('currentAvatar').getAttribute('src');
        renderAvatarOptions(current);
        avatarModal.show();
    });

    document.getElementById('avatarForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const chosen = document.querySelector('input[name="avatar"]:checked');
        if (!chosen) return;

        const userId = document.getElementById('userIdHidden').value;
        const avatarPath = chosen.value;

        try {
            const fd = new FormData();
            fd.append('avatarPath', avatarPath);
            const res = await fetch(`/welcome/profile/${userId}/avatar`, {method: 'POST', body: fd});
            const data = await res.json();
            if (!res.ok || !data.success) {
                showToast(data.error || 'C·∫≠p nh·∫≠t avatar th·∫•t b·∫°i', true);
                return;
            }
            document.getElementById('currentAvatar').src = data.avatar;
            showToast('‚úÖ C·∫≠p nh·∫≠t avatar th√†nh c√¥ng!', false);
            bootstrap.Modal.getInstance(document.getElementById('avatarModal')).hide();
        } catch (err) {
            showToast('L·ªói m·∫°ng khi c·∫≠p nh·∫≠t avatar', true);
        }
    });

    function isWalletActivated() {
        return localStorage.getItem(STORAGE_KEYS.walletActive) === 'true';
    }

    function updateWalletUI() {
        document.getElementById('walletStatus').textContent = isWalletActivated() ? 'ƒê√£ k√≠ch ho·∫°t' : 'Ch∆∞a k√≠ch ho·∫°t';
    }

    document.getElementById('savePhoneBtn')?.addEventListener('click', () => {
        const v = document.getElementById('newPhone').value.trim();
        if (v) {
            localStorage.setItem(STORAGE_KEYS.phone, v);
            document.getElementById('phoneDisplay').innerText = v;
            showToast('‚úÖ L∆∞u s·ªë ƒëi·ªán tho·∫°i!', false);
        }
    });
    document.getElementById('saveCountryBtn').addEventListener('click', () => {
        const v = document.getElementById('newCountry').value;
        if (v) {
            localStorage.setItem(STORAGE_KEYS.country, v);
            document.getElementById('countryDisplay').innerText = v;
            showToast('‚úÖ C·∫≠p nh·∫≠t qu·ªëc gia!', false);
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        initProfile();
        updateWalletUI();
        const walletCard = document.getElementById('walletCard');
        const activateModalEl = document.getElementById('activateWalletModal');
        let activateModal = null;
        if (activateModalEl) {
            activateModal = new bootstrap.Modal(activateModalEl);
        }

        walletCard.addEventListener('click', () => {
            if (isWalletActivated()) {
                openPinPopup();
            } else if (activateModal) {
                activateModal.show();
            }
        });

        document.getElementById('activateWalletForm')?.addEventListener('submit', (e) => {
            e.preventDefault();
            const pin = document.getElementById('pinCode').value;
            if (!/^\d{4}$/.test(pin)) {
                showToast('‚ö†Ô∏è M·∫≠t kh·∫©u ph·∫£i g·ªìm ƒë√∫ng 4 ch·ªØ s·ªë!', true);
                return;
            }
            localStorage.setItem(STORAGE_KEYS.walletPin, pin);
            localStorage.setItem(STORAGE_KEYS.walletActive, 'true');
            updateWalletUI();
            if (activateModal) activateModal.hide();
            showToast('‚úÖ V√≠ GamePay ƒë√£ ƒë∆∞·ª£c k√≠ch ho·∫°t!', false);
        });

        document.getElementById('verifyPinBtn').addEventListener('click', verifyPin);
        document.getElementById('closePinBtn').addEventListener('click', closePinPopup);

        const deleteBtn = document.getElementById('btnDeleteAccount');
        const deleteModalEl = document.getElementById('deleteUserModal');
        const deleteModal = new bootstrap.Modal(deleteModalEl);
        const confirmDeleteBtn = document.getElementById('confirmDeleteUserBtn');

        deleteBtn.addEventListener('click', () => {
            deleteModal.show();
        });

        confirmDeleteBtn.addEventListener('click', async () => {
            const userId = document.getElementById('userIdHidden').value;
            try {
                const csrf = getCsrf();
                const headers = {'X-Requested-With': 'XMLHttpRequest'};
                if (csrf.token && csrf.header) {
                    headers[csrf.header] = csrf.token;
                }

                const res = await fetch(`/welcome/profile/${userId}/delete`, {
                    method: 'POST',
                    headers
                });
                const data = await res.json();
                if (res.ok && data.success) {
                    showToast('‚úÖ ƒê√£ g·ª≠i email x√°c nh·∫≠n xo√° t√†i kho·∫£n. Vui l√≤ng ki·ªÉm tra h·ªôp th∆∞!', false);
                    deleteModal.hide();
                    window.location.href = data.redirectUrl || '/welcome';
                } else {
                    showToast(data.error || 'X√≥a t√†i kho·∫£n th·∫•t b·∫°i!', true);
                }
            } catch (e) {
                showToast('L·ªói m·∫°ng khi x√≥a t√†i kho·∫£n!', true);
            }
        });
    });

    function openPinPopup() {
        document.getElementById('pinPopup').style.display = 'flex';
        document.getElementById('walletPin').value = '';
        document.getElementById('pinError').textContent = '';
    }

    function closePinPopup() {
        document.getElementById('pinPopup').style.display = 'none';
    }

    function verifyPin() {
        const pin = document.getElementById('walletPin').value.trim();
        const saved = localStorage.getItem(STORAGE_KEYS.walletPin);
        if (pin === saved) window.location.href = '/welcome/gamePay';
        else document.getElementById('pinError').textContent = 'PIN kh√¥ng ƒë√∫ng. Vui l√≤ng th·ª≠ l·∫°i.';
    }
</script>
<script th:src="@{/Accest/JS/code.js}"></script>
</body>
</html>
