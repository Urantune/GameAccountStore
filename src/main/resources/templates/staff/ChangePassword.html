<!doctype html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>ƒê·ªïi m·∫≠t kh·∫©u</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <!-- CSRF -->
    <meta th:if="${_csrf != null}" name="_csrf" th:content="${_csrf.token}"/>
    <meta th:if="${_csrf != null}" name="_csrf_header" th:content="${_csrf.headerName}"/>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>

    <style>
        body {
            background: #0a0a0a;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card {
            width: 420px;
            background: #111;
            color: #fff;
            border-radius: 12px;
        }

        .form-control {
            background: #1c1c1c;
            border: 1px solid #333;
            color: #fff;
        }

        .form-control:focus {
            background: #1c1c1c;
            color: #fff;
            border-color: #0d6efd;
            box-shadow: none;
        }

        .toast-message {
            position: fixed;
            right: 16px;
            bottom: 16px;
            opacity: 0;
            transition: opacity .2s;
            z-index: 2000;
            padding: 8px 12px;
            border-radius: 6px
        }

        .toast-message.show {
            opacity: 1
        }
    </style>
</head>

<body>

<div class="card shadow p-4">
    <h4 class="text-center mb-3">üîí ƒê·ªïi m·∫≠t kh·∫©u</h4>

    <input type="hidden" id="userId" th:value="${customer.customerId}"/>

    <div class="mb-3">
        <label class="form-label">M·∫≠t kh·∫©u m·ªõi</label>
        <input type="password" id="newPassword" class="form-control" placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi">
    </div>

    <div class="mb-3">
        <label class="form-label">Nh·∫≠p l·∫°i m·∫≠t kh·∫©u</label>
        <input type="password" id="confirmPassword" class="form-control" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u">
    </div>

    <button id="btnChangePassword" class="btn btn-primary w-100">
        X√°c nh·∫≠n ƒë·ªïi m·∫≠t kh·∫©u
    </button>

    <a th:href="@{/welcome/profile}" class="btn btn-link text-secondary mt-3">
        ‚Üê Quay l·∫°i trang c√° nh√¢n
    </a>
</div>

<div id="toast" class="toast-message"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const $ = (s) => document.querySelector(s);

    function getCsrf() {
        const token = document.querySelector('meta[name="_csrf"]')?.content;
        const header = document.querySelector('meta[name="_csrf_header"]')?.content;
        return { token, header };
    }

    function showToast(msg, error) {
        const t = $('#toast');
        t.textContent = msg;
        t.style.background = error ? '#e74c3c' : '#2ecc71';
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 3000);
    }

    $('#btnChangePassword').addEventListener('click', async () => {
        const newPass = $('#newPassword').value.trim();
        const confirm = $('#confirmPassword').value.trim();
        const userId = $('#userId').value;

        if (!newPass || !confirm) {
            showToast('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß m·∫≠t kh·∫©u!', true);
            return;
        }

        if (newPass.length < 6) {
            showToast('M·∫≠t kh·∫©u t·ªëi thi·ªÉu 6 k√Ω t·ª±!', true);
            return;
        }

        if (newPass !== confirm) {
            showToast('M·∫≠t kh·∫©u nh·∫≠p l·∫°i kh√¥ng kh·ªõp!', true);
            return;
        }

        try {
            const csrf = getCsrf();
            const headers = {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            };
            if (csrf.token && csrf.header) headers[csrf.header] = csrf.token;

            const res = await fetch(`/welcome/profile/${userId}/change-password`, {
                method: 'POST',
                headers,
                body: JSON.stringify({ newPassword: newPass })
            });

            const data = await res.json();

            if (res.ok && data.success) {
                showToast('‚úÖ ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng!', false);
                $('#newPassword').value = '';
                $('#confirmPassword').value = '';
            } else {
                showToast(data.error || 'ƒê·ªïi m·∫≠t kh·∫©u th·∫•t b·∫°i!', true);
            }
        } catch {
            showToast('L·ªói m·∫°ng!', true);
        }
    });
</script>

</body>
</html>
